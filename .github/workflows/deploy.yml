name: Deploy

on:
  push: # Remove this for the one below once it works
    branches:
        - "**"
  # workflow_run:
  #   workflows: ["Scala CI"]
  #   types:
  #     - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    # UNCOMMENT THIS
#    if: github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/master'
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: assembly
      run: |
        sed -i 's!\"\.\./botDB\.sqlite3"!\"botDB\.sqlite3\"!g' /home/runner/work/sBots/sBots/main/src/main/resources/application.conf
        cat /home/runner/work/sBots/sBots/main/src/main/resources/application.conf
        echo '${{ secrets.ABAR_TOKEN }}' > /home/runner/work/sBots/sBots/aBarberoBot/src/main/resources/abar_ABarberoBot.token
        echo '${{ secrets.CALA_TOKEN }}' > /home/runner/work/sBots/sBots/calandroBot/src/main/resources/cala_CalandroBot.token
        echo '${{ secrets.MOS_TOKEN }}' > /home/runner/work/sBots/sBots/m0sconiBot/src/main/resources/mos_M0sconiBot.token
        echo '${{ secrets.RPHJB_TOKEN }}' > /home/runner/work/sBots/sBots/richardPHJBensonBot/src/main/resources/rphjb_RichardPHJBensonBot.token
        echo '${{ secrets.XAH_TOKEN }}' > /home/runner/work/sBots/sBots/xahLeeBot/src/main/resources/xah_XahLeeBot.token
        echo '${{ secrets.YTAI_TOKEN }}' > /home/runner/work/sBots/sBots/youTuboAncheI0Bot/src/main/resources/ytai_YouTuboAncheI0Bot.token
        sbt "assembly"
    - name: Create SSH key
      run: |
        install -m 600 -D /dev/null ~/.ssh/id_rsa
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
    - name: Kill running bots, move artifactory & restart bots
      run: |
        ssh -t -o StrictHostKeyChecking=no ubuntu@${{ secrets.DEPLOY_SERVER_IP }} 'killall java'
        rsync -av -e 'ssh -o StrictHostKeyChecking=no' /home/runner/work/sBots/sBots/main/target/scala-2.13/main.jar ubuntu@${{ secrets.DEPLOY_SERVER_IP }}:/home/ubuntu/bots/main.jar
        rsync -av -e 'ssh -o StrictHostKeyChecking=no' /home/runner/work/sBots/sBots/botDB.sqlite3 ubuntu@${{ secrets.DEPLOY_SERVER_IP }}:/home/ubuntu/bots/botDB.sqlite3
        ssh -t -o StrictHostKeyChecking=no ubuntu@${{ secrets.DEPLOY_SERVER_IP }} 'cd /home/ubuntu/bots; /usr/bin/java -cp main.jar com.benkio.main.MainWebhook'
